<div class="market-data-dashboard">
  <h2>Stock Market Dashboard</h2>

  <details class="page-guide">
    <summary>How to use this page</summary>
    <div class="guide-content">
      <h4>Quick start</h4>
      <ol>
        <li>Type a <strong>ticker</strong> (e.g. <code>AAPL</code>, <code>MSFT</code>, <code>GLD</code>) in the text box.</li>
        <li>Pick <strong>From</strong> and <strong>To</strong> dates. Keep the range short for minute data (1&ndash;5 days) or longer for daily data.</li>
        <li>Choose a <strong>timespan</strong> &mdash; Minute, Hourly, Daily, Weekly, or Monthly.</li>
        <li>Click <strong>Fetch Data</strong>. Results are cached in the database so the next fetch for the same range is instant.</li>
      </ol>
      <h4>What you'll see</h4>
      <ul>
        <li><strong>Candlestick chart</strong> &mdash; Green bars = price went up, Red bars = price went down. Hover for exact OHLC values.</li>
        <li><strong>Volume chart</strong> &mdash; Bars showing trade volume. Tall bars = high trading activity.</li>
        <li><strong>Line chart</strong> &mdash; Closing prices over time.</li>
        <li><strong>Data table</strong> &mdash; Click any column header to sort. VWAP = volume-weighted average price (institutional fair-value benchmark).</li>
      </ul>
      <h4>Where to go next</h4>
      <ul>
        <li><strong>Stock Analysis</strong> &mdash; Fetch months of minute data in automated monthly chunks.</li>
        <li><strong>Technical Analysis</strong> &mdash; Overlay SMA, EMA, and RSI indicators on your data.</li>
        <li><strong>Strategy Lab</strong> &mdash; Run backtests on the data you've fetched here.</li>
      </ul>
      <div class="guide-tip">
        Note: All data is <strong>15-minute delayed</strong> and limited to the past <strong>2 years</strong> (Polygon Starter plan).
      </div>
    </div>
  </details>

  <!-- Search Controls + Calendar -->
  <div class="controls-row">
    <div class="search-form">
      <input
        [(ngModel)]="ticker"
        placeholder="Ticker (e.g., AAPL)"
        (keyup.enter)="fetchData()"
      />
      <input [(ngModel)]="fromDate" type="date" [min]="minDate" />
      <input [(ngModel)]="toDate" type="date" [min]="minDate" />
      <select [(ngModel)]="timespan">
        <option value="minute">Minute</option>
        <option value="hour">Hourly</option>
        <option value="day">Daily</option>
        <option value="week">Weekly</option>
        <option value="month">Monthly</option>
      </select>
      <button (click)="fetchData()" [disabled]="loading">
        {{ loading ? 'Loading...' : 'Fetch Data' }}
      </button>
    </div>

    <app-market-calendar
      [holidays]="holidays"
      [loading]="holidaysLoading"
      (dateSelect)="onCalendarDateSelect($event)"
    />
  </div>

  <!-- Error -->
  @if (error) {
    <div class="error-message">{{ error }}</div>
  }

  <!-- Loading -->
  @if (loading) {
    <div class="loading">Fetching data for {{ ticker }}...</div>
  }

  <!-- Dashboard Content -->
  @if (aggregates.length > 0 && !loading) {
    <div class="dashboard-content">
      <h3>{{ ticker }} &mdash; {{ aggregates.length }} bars</h3>

      <!-- Summary Stats -->
      <app-summary-stats [summary]="summary"></app-summary-stats>

      <!-- Candlestick Chart -->
      <div class="chart-section">
        <h4>Candlestick Chart (OHLC)</h4>
        <app-candlestick-chart [data]="aggregates" [ticker]="ticker"></app-candlestick-chart>
      </div>

      <!-- Volume Chart -->
      <div class="chart-section">
        <h4>Volume</h4>
        <app-volume-chart [data]="aggregates"></app-volume-chart>
      </div>

      <!-- Line Chart -->
      <div class="chart-section">
        <h4>Closing Prices</h4>
        <app-line-chart [data]="aggregates" [ticker]="ticker"></app-line-chart>
      </div>

      <!-- Data Preview Table -->
      <div class="data-table-section">
        <p-table
          [value]="aggregates"
          [paginator]="true"
          [rows]="15"
          [rowsPerPageOptions]="[10, 15, 25, 50]"
          [sortField]="'timestamp'"
          [sortOrder]="-1"
          [scrollable]="true"
          scrollHeight="500px"
          styleClass="p-datatable-striped p-datatable-sm"
          [tableStyle]="{ 'min-width': '50rem' }"
        >
          <ng-template #caption>
            <div class="table-caption">
              Data Preview &mdash; {{ aggregates.length }} rows
            </div>
          </ng-template>
          <ng-template #header>
            <tr>
              <th pSortableColumn="timestamp">Date <p-sortIcon field="timestamp" /></th>
              <th pSortableColumn="open">Open <p-sortIcon field="open" /></th>
              <th pSortableColumn="high">High <p-sortIcon field="high" /></th>
              <th pSortableColumn="low">Low <p-sortIcon field="low" /></th>
              <th pSortableColumn="close">Close <p-sortIcon field="close" /></th>
              <th pSortableColumn="volume">Volume <p-sortIcon field="volume" /></th>
              <th pSortableColumn="volumeWeightedAveragePrice">VWAP <p-sortIcon field="volumeWeightedAveragePrice" /></th>
            </tr>
          </ng-template>
          <ng-template #body let-bar>
            <tr>
              <td>{{ bar.timestamp | date:(timespan === 'minute' || timespan === 'hour' ? 'yyyy-MM-dd HH:mm' : 'yyyy-MM-dd') }}</td>
              <td>{{ bar.open | number:'1.2-2' }}</td>
              <td>{{ bar.high | number:'1.2-2' }}</td>
              <td>{{ bar.low | number:'1.2-2' }}</td>
              <td>{{ bar.close | number:'1.2-2' }}</td>
              <td>{{ bar.volume | number:'1.0-0' }}</td>
              <td>{{ bar.volumeWeightedAveragePrice | number:'1.2-2' }}</td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </div>
  }
</div>
