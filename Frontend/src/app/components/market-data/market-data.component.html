<div class="market-data-dashboard">
  <h2>Stock Market Dashboard</h2>

  <!-- Search Controls -->
  <div class="search-form">
    <input
      [(ngModel)]="ticker"
      placeholder="Ticker (e.g., AAPL)"
      (keyup.enter)="fetchData()"
    />
    <input [(ngModel)]="fromDate" type="date" />
    <input [(ngModel)]="toDate" type="date" />
    <select [(ngModel)]="timespan">
      <option value="day">Daily</option>
      <option value="hour">Hourly</option>
      <option value="week">Weekly</option>
      <option value="month">Monthly</option>
    </select>
    <button (click)="fetchData()" [disabled]="loading">
      {{ loading ? 'Loading...' : 'Fetch Data' }}
    </button>
  </div>

  <!-- Error -->
  @if (error) {
    <div class="error-message">{{ error }}</div>
  }

  <!-- Loading -->
  @if (loading) {
    <div class="loading">Fetching data for {{ ticker }}...</div>
  }

  <!-- Dashboard Content -->
  @if (aggregates.length > 0 && !loading) {
    <div class="dashboard-content">
      <h3>{{ ticker }} &mdash; {{ aggregates.length }} bars</h3>

      <!-- Summary Stats -->
      <app-summary-stats [summary]="summary"></app-summary-stats>

      <!-- Candlestick Chart -->
      <div class="chart-section">
        <h4>Candlestick Chart (OHLC)</h4>
        <app-candlestick-chart [data]="aggregates" [ticker]="ticker"></app-candlestick-chart>
      </div>

      <!-- Volume Chart -->
      <div class="chart-section">
        <h4>Volume</h4>
        <app-volume-chart [data]="aggregates"></app-volume-chart>
      </div>

      <!-- Line Chart -->
      <div class="chart-section">
        <h4>Closing Prices</h4>
        <app-line-chart [data]="aggregates" [ticker]="ticker"></app-line-chart>
      </div>

      <!-- Data Preview Table -->
      <div class="data-table-section">
        <p-table
          [value]="aggregates"
          [paginator]="true"
          [rows]="15"
          [rowsPerPageOptions]="[10, 15, 25, 50]"
          [sortField]="'timestamp'"
          [sortOrder]="-1"
          [scrollable]="true"
          scrollHeight="500px"
          styleClass="p-datatable-striped p-datatable-sm"
          [tableStyle]="{ 'min-width': '50rem' }"
        >
          <ng-template #caption>
            <div class="table-caption">
              Data Preview &mdash; {{ aggregates.length }} rows
            </div>
          </ng-template>
          <ng-template #header>
            <tr>
              <th pSortableColumn="timestamp">Date <p-sortIcon field="timestamp" /></th>
              <th pSortableColumn="open">Open <p-sortIcon field="open" /></th>
              <th pSortableColumn="high">High <p-sortIcon field="high" /></th>
              <th pSortableColumn="low">Low <p-sortIcon field="low" /></th>
              <th pSortableColumn="close">Close <p-sortIcon field="close" /></th>
              <th pSortableColumn="volume">Volume <p-sortIcon field="volume" /></th>
              <th pSortableColumn="volumeWeightedAveragePrice">VWAP <p-sortIcon field="volumeWeightedAveragePrice" /></th>
            </tr>
          </ng-template>
          <ng-template #body let-bar>
            <tr>
              <td>{{ bar.timestamp | date:'yyyy-MM-dd' }}</td>
              <td>{{ bar.open | number:'1.2-2' }}</td>
              <td>{{ bar.high | number:'1.2-2' }}</td>
              <td>{{ bar.low | number:'1.2-2' }}</td>
              <td>{{ bar.close | number:'1.2-2' }}</td>
              <td>{{ bar.volume | number:'1.0-0' }}</td>
              <td>{{ bar.volumeWeightedAveragePrice | number:'1.2-2' }}</td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </div>
  }
</div>
