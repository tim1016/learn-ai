<p-table
  [value]="chunks()"
  [scrollable]="true"
  scrollHeight="400px"
  styleClass="p-datatable-striped p-datatable-sm"
  [tableStyle]="{ 'min-width': '40rem' }"
  dataKey="index"
>
  <ng-template #caption>
    <div class="table-caption">
      Fetch Queue &mdash; {{ completedCount() }} / {{ chunks().length }} chunks &middot;
      {{ totalBars() | number }} bars
    </div>
  </ng-template>

  <ng-template #header>
    <tr>
      <th style="width: 3rem">#</th>
      <th>Status</th>
      <th>From</th>
      <th>To</th>
      <th style="text-align: right">Bars</th>
      <th style="text-align: right">Duration</th>
      <th>Options</th>
      <th style="width: 7rem; text-align: center">Actions</th>
    </tr>
  </ng-template>

  <ng-template #body let-chunk>
    <tr>
      <td>{{ chunk.index + 1 }}</td>
      <td>
        <span class="status-badge" [ngClass]="'status-' + chunk.status">
          {{ chunk.status | titlecase }}
        </span>
        @if (chunk.status === 'error' && chunk.errorMessage) {
          <span class="error-msg">{{ chunk.errorMessage }}</span>
        }
      </td>
      <td>{{ chunk.fromDate }}</td>
      <td>{{ chunk.toDate }}</td>
      <td style="text-align: right">
        @if (chunk.barCount > 0) {
          {{ chunk.barCount | number }}
        } @else {
          —
        }
      </td>
      <td style="text-align: right">{{ formatDuration(chunk.durationMs) }}</td>
      <td>
        @if (chunk.optionsStatus === 'fetching') {
          <span class="status-badge status-fetching">
            {{ chunk.optionsFetchedCount ?? 0 }}/{{ chunk.optionsContractCount ?? '?' }}
          </span>
        } @else if (chunk.optionsStatus === 'complete' && chunk.optionsContractCount) {
          <span class="status-badge status-complete">
            {{ chunk.optionsFetchedCount }}/{{ chunk.optionsContractCount }}
          </span>
        } @else if (chunk.optionsStatus === 'error') {
          <span class="status-badge status-error">Error</span>
        } @else {
          —
        }
      </td>
      <td style="text-align: center">
        <div class="action-btns">
          <button
            class="view-chunk-btn"
            title="View chunk details"
            [disabled]="chunk.status !== 'complete'"
            (click)="onViewClick($event, chunk)"
          >
            <i class="pi pi-eye"></i>
          </button>
          <button
            class="refresh-chunk-btn"
            title="Re-fetch this chunk from Polygon.io"
            [disabled]="chunk.status === 'fetching'"
            (click)="onRefreshClick($event, chunk)"
          >
            <i class="pi pi-refresh"></i>
          </button>
        </div>
      </td>
    </tr>
  </ng-template>
</p-table>
